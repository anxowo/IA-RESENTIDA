const express = require("express");
const { exec } = require("child_process");
const fetch = require("node-fetch"); // AsegÃºrate de tener esto (o usa fetch nativo si Node es nuevo)

const app = express();
app.use(express.json());

// --- CONFIGURACIÃ“N ---
const OLLAMA_URL = "http://127.0.0.1:11434/api/generate";
const MODELO = "phi3:mini"; // O 'tinyllama' si quieres mÃ¡s velocidad
const SCRIPT_BACKUP = "/opt/IA-RESENTIDA/scripts/evento_ia.sh";

// --- FUNCIÃ“N: LAS MANOS (Ejecutar comandos) ---
function ejecutarComando(comando, descripcion, res) {
    console.log(`âš™ï¸ Ejecutando: ${comando}`);
    
    // Encadenamos el comando con tu script de backup
    const comandoCompleto = `${comando} && ${SCRIPT_BACKUP} "${descripcion}"`;

    exec(comandoCompleto, { shell: "/bin/bash" }, (error, stdout, stderr) => {
        if (error) {
            console.error(`âŒ Error: ${stderr}`);
            res.json({ respuesta: `Error al ejecutar: ${stderr}` });
        } else {
            console.log(`âœ… Ã‰xito: ${stdout}`);
            // Devolvemos la respuesta confirmando que se hizo y se guardÃ³ en GitHub
            res.json({ respuesta: `âœ… AcciÃ³n completada: ${descripcion}. Backup realizado en GitHub.` });
        }
    });
}

// --- FUNCIÃ“N: EL CEREBRO (Consultar a Ollama) ---
async function consultarIA(mensaje, res) {
    try {
        console.log(`ðŸ§  Pensando: ${mensaje}`);
        const response = await fetch(OLLAMA_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: MODELO,
                prompt: mensaje,
                stream: false,
                options: { temperature: 0.1, num_predict: 100 }
            })
        });
        const data = await response.json();
        res.json({ respuesta: data.response });
    } catch (err) {
        res.json({ respuesta: "Error conectando con el cerebro de la IA." });
    }
}

// --- RUTAS ---
app.post("/mensaje", (req, res) => {
    const mensaje = req.body.mensaje.toLowerCase(); // Convertir a minÃºsculas para facilitar

    // ðŸ¤– DETECTOR DE INTENCIONES (AquÃ­ es donde decides quÃ© hace)
    
    // CASO 1: Reiniciar Apache
    if (mensaje.includes("reinicia") && mensaje.includes("apache")) {
        ejecutarComando(
            "systemctl restart apache2", 
            "Mantenimiento: Reinicio de servicio Apache solicitado por usuario", 
            res
        );
    }
    // CASO 2: Ver espacio en disco
    else if (mensaje.includes("espacio") && mensaje.includes("disco")) {
        ejecutarComando(
            "df -h", 
            "Consulta: VerificaciÃ³n de espacio en disco", 
            res
        );
    }
    // CASO 3: Charla normal (Si no es orden tÃ©cnica, habla con la IA)
    else {
        consultarIA(req.body.mensaje, res);
    }
});

app.listen(3000, () => {
    console.log("ðŸ¤– OpenClaw v2.0 (Con manos y cerebro) escuchando en puerto 3000");
});
